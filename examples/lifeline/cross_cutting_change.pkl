/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"
import "@oci/oci.pkl"
import "@oci/core/vcn.pkl"
import "@oci/core/internetgateway.pkl"
import "@oci/core/networksecuritygroup.pkl"

import "./vars.pkl"

description {
    text = """
    This forma is supposed to be used in patch mode and demonstrate how to make minimal
    cross-cutting changes. Typical use cases would be to harden systems, adding consistent
    metadata, compliance, cost and performance optimizations and similar. Anyone in the team
    should be able to apply this forma, but its sweet spot is to be used by security engineers,
    consultants and similar roles.

    Apply this forma in patch mode to add a specific tag to multiple existing resources.

    One can run destroy using this forma, but it shouldn't be done.
    """
    confirm = true
}

properties {
    crossCuttingTag = new formae.Prop {
        flag = "crossCuttingTag"
        default = "SecurityReview"
    }

    crossCuttingTagValue = new formae.Prop {
        flag = "crossCuttingTagValue"
        default = "2025-Q1-Review"
    }
}

forma {
    vars.stack
    vars.target

    local stackLabel = vars.stack.label

    local lifelineVcn = new vcn.VcnResolvable {
        label = "lifeline-vcn"
        stack = stackLabel
    }

    new internetgateway.InternetGateway {
        label = "lifeline-igw"
        compartmentId = vars.compartmentId.value
        vcnId = lifelineVcn.id
        isEnabled = true
        tags { new { key = properties.crossCuttingTag.value; value = properties.crossCuttingTagValue.value } }
    }

    new networksecuritygroup.NetworkSecurityGroup {
        label = "lifeline-web-nsg"
        compartmentId = vars.compartmentId.value
        vcnId = lifelineVcn.id
        tags { new { key = properties.crossCuttingTag.value; value = properties.crossCuttingTagValue.value } }
    }

    new networksecuritygroup.NetworkSecurityGroup {
        label = "lifeline-db-nsg"
        compartmentId = vars.compartmentId.value
        vcnId = lifelineVcn.id
        tags { new { key = properties.crossCuttingTag.value; value = properties.crossCuttingTagValue.value } }
    }
}

