/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

module oci

import "@formae/formae.pkl"

typealias Region = "ap-batam-1" |
  "ap-chiyoda-1" |
  "ap-chuncheon-1" |
  "ap-dcc-canberra-1" |
  "ap-dcc-dublin-1" |
  "ap-dcc-dublin-2" |
  "ap-dcc-milan-1" |
  "ap-dcc-milan-2" |
  "ap-dcc-phoenix-1" |
  "ap-dcc-phoenix-2" |
  "ap-dcc-phoenix-4" |
  "ap-dcc-rating-1" |
  "ap-dcc-rating-2" |
  "ap-hobsonville-1" |
  "ap-hyderabad-1" |
  "ap-ibaraki-1" |
  "ap-melbourne-1" |
  "ap-mumbai-1" |
  "ap-osaka-1" |
  "ap-seoul-1" |
  "ap-singapore-1" |
  "ap-sydney-1" |
  "ap-tokyo-1" |
  "ca-montreal-1" |
  "ca-toronto-1" |
  "eu-amsterdam-1" |
  "eu-dcc-dublin-1" |
  "eu-dcc-dublin-2" |
  "eu-dcc-milan-1" |
  "eu-dcc-milan-2" |
  "eu-dcc-rating-1" |
  "eu-dcc-rating-2" |
  "eu-frankfurt-1" |
  "eu-madrid-1" |
  "eu-marseille-1" |
  "eu-milan-1" |
  "eu-paris-1" |
  "eu-stockholm-1" |
  "eu-zurich-1" |
  "il-jerusalem-1" |
  "me-abudhabi-1" |
  "me-dcc-muscat-1" |
  "me-dubai-1" |
  "me-jeddah-1" |
  "mx-monterrey-1" |
  "mx-queretaro-1" |
  "sa-bogota-1" |
  "sa-santiago-1" |
  "sa-saopaulo-1" |
  "sa-valparaiso-1" |
  "sa-vinhedo-1" |
  "uk-cardiff-1" |
  "uk-gov-cardiff-1" |
  "uk-gov-london-1" |
  "uk-london-1" |
  "us-ashburn-1" |
  "us-chicago-1" |
  "us-gov-ashburn-1" |
  "us-gov-chicago-1" |
  "us-gov-phoenix-1" |
  "us-langley-1" |
  "us-luke-1" |
  "us-phoenix-1" |
  "us-sanjose-1" |
  "us-saltlake-2"

open class Config {
  hidden fixed type: String = "OCI"
  hidden profile: String?
  hidden configFilePath: String?
  hidden region: Region

  fixed Type: String = type
  fixed Profile: String? = profile
  fixed ConfigFilePath: String? = configFilePath
  fixed Region: Region = region
}

class FieldHint extends formae.FieldHint {}

class ResourceHint extends formae.ResourceHint {
  hidden outputKeyTransformation: (String) -> String = (it) -> it.capitalize()
}

class SubResourceHint extends formae.SubResourceHint {
  hidden outputKeyTransformation: (String) -> String = (it) -> it.capitalize()
}

/// Converts Listing<formae.Tag> to OCI FreeformTags format (Mapping<String, String>)
/// In:  [{key: "Env", value: "prod"}, {key: "Team", value: "platform"}]
/// Out: {"Env": "prod", "Team": "platform"}
class Transform {

  tagsToFreeformTags: (Any) -> Mapping<String, String> = (tags) ->
    if (tags == null)
      new Mapping<String, String> {}
    else
      tags.toList().fold(new Mapping<String, String> {}, (acc, tag) ->
        let (tagMap = tag.toMap())
        let (key = tagMap.getOrNull("key") ?? tagMap.getOrNull("Key"))
        let (value = tagMap.getOrNull("value") ?? tagMap.getOrNull("Value"))
          if (key != null && value != null)
            (acc) { [key.toString()] = value.toString() }
          else
            acc
      )
}

const transform: Transform = new Transform {}
